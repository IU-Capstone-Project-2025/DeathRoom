# Руководство по настройке мультиплеера DeathRoom

## Исправленные проблемы

1. **Фильтрация игроков по ID вместо имени** - теперь клиенты правильно отображают друг друга
2. **Уникальные имена игроков** - автоматическая генерация уникальных имен
3. **Отключение GameManager в сетевом режиме** - предотвращает конфликты со спавном игроков
4. **Улучшенное логирование** - больше информации для отладки
5. **Смена localhost на 127.0.0.1** - лучшая совместимость сети

## Пошаговая настройка

### 1. Запуск сервера

Перейдите в папку сервера и запустите:

```bash
cd server/DeathRoom-Backend
dotnet run
```

Сервер должен запуститься на порту 9050 и выводить:

```
Server started on port 9050
```

### 2. Настройка клиентов

#### Вариант A: Через Inspector Unity

1. Выберите объект с компонентом `Client`
2. Установите уникальные значения для `Player Name`:
   - Клиент 1: "Player1"
   - Клиент 2: "Player2"
3. Убедитесь что `Server Address` = "127.0.0.1"
4. Убедитесь что `Server Port` = 9050

#### Вариант B: Через NetworkTestUI (рекомендуется)

1. Добавьте компонент `NetworkTestUI` на любой объект в сцене
2. Создайте UI элементы:
   - Input Field для имени игрока
   - Input Field для адреса сервера
   - Input Field для порта
   - Button для подключения
   - Button для отключения
   - Text для статуса
   - Text для списка игроков
3. Привяжите элементы к NetworkTestUI компоненту

### 3. Тестирование

1. **Запустите сервер**
2. **Соберите клиент** (Build Settings → Build)
3. **Запустите первый экземпляр** клиента
4. **Запустите второй экземпляр** клиента
5. **В каждом клиенте:**
   - Установите уникальное имя игрока
   - Подключитесь к серверу

### 4. Ожидаемое поведение

После подключения двух клиентов вы должны увидеть:

1. **В консоли сервера:**

```
Player Player1 logged in from [port]
Player Player2 logged in from [port]
```

2. **В консоли клиента 1:**

```
Connected to server
NetworkPlayer initialized: Player2 (ID: 2) at [position]
```

3. **В консоли клиента 2:**

```
Connected to server
NetworkPlayer initialized: Player1 (ID: 1) at [position]
```

4. **В игре:**
   - Каждый клиент видит своего локального игрока
   - Каждый клиент видит других игроков как NetworkPlayer
   - Движения синхронизируются между клиентами

### 5. Отладка проблем

#### Проблема: Клиенты не видят друг друга

- Проверьте логи: "Processing WorldStatePacket with X players"
- Убедитесь что имена игроков уникальны
- Проверьте что localPlayerId устанавливается правильно

#### Проблема: Соединение не устанавливается

- Проверьте что сервер запущен
- Проверьте IP адрес (127.0.0.1 вместо localhost)
- Проверьте порт 9050
- Проверьте firewall

#### Проблема: Игроки спавнятся дважды

- Убедитесь что GameManager отключен в сетевом режиме
- Проверьте логи: "Network mode detected - GameManager will not spawn players"

### 6. Дополнительные настройки

#### Настройка сервера

Можно изменить через переменные окружения:

- `DEATHROOM_SERVER_PORT` - порт сервера (по умолчанию 9050)
- `DEATHROOM_BROADCAST_INTERVAL_MS` - интервал отправки состояния (по умолчанию 15ms)

#### Настройка клиента

В компоненте Client:

- `sendRate` - частота отправки движений (по умолчанию 20 Hz)
- `interpolationSpeed` - скорость интерполяции NetworkPlayer (по умолчанию 10)

## Структура файлов

Измененные файлы:

- `Client.cs` - основная логика клиента с исправлениями
- `NetworkPlayer.cs` - улучшенное логирование
- `MultiplayerManager.cs` - уникальные имена игроков
- `GameManager.cs` - предотвращение конфликтов
- `NetworkTestUI.cs` - новый UI для тестирования

## Следующие шаги

После успешного тестирования локального мультиплеера можно:

1. Развернуть сервер на удаленном хосте
2. Настроить NAT/port forwarding для игры через интернет
3. Добавить комнаты/лобби для матчмейкинга
4. Реализовать дополнительные игровые механики
